generator zod {
  provider = "zod-prisma-types"
  output   = "../../../packages/shared/zod/generated"
}

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ConnectionType {
  friend
  dating
}

enum ConnectionStatus {
  pending
  accepted
  rejected
  blocked
}

enum Gender {
  male
  female
  non_binary
  other
  unspecified
}

enum HasKids {
  yes
  no
  unspecified
}

enum PreferenceGender {
  male
  female
  non_binary
  any
}

enum RelationshipStatus {
  single
  in_relationship
  married
  other
  unspecified
}

model Tag {
  id               Int              @id @default(autoincrement())
  slug             String           @unique
  name             String           @unique
  translations     TagTranslation[]
  profileTags      ProfileTag[]
  isApproved       Boolean          @default(false)
  isDeleted        Boolean          @default(false)
  isHidden         Boolean          @default(false)
  isCreatedByAdmin Boolean          @default(false)
  createdBy        String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
}

model TagTranslation {
  id     Int    @id @default(autoincrement())
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tagId  Int
  locale String // e.g. "en", "de", "fr"
  name   String // e.g. "Farm stay", "Ferien auf dem Bauernhof"

  @@unique([tagId, locale])
}

model ProfileTag {
  id    String @id @default(cuid())
  tag   Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tagId Int

  profileId String?
  profile   Profile? @relation(fields: [profileId], references: [id])

  datingProfileId String?
  datingProfile   DatingProfile? @relation(fields: [datingProfileId], references: [id])

  @@unique([profileId, tagId])
  @@unique([datingProfileId, tagId])
}

model DatingPreference {
  userId     String @id
  prefAgeMin Int?
  prefAgeMax Int?

  latitude   Float?
  longitude  Float?
  prefGender PreferenceGender @default(any)

  profile DatingProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)
}

model ConnectionRequest {
  id         String           @id @default(cuid())
  fromUser   User             @relation("RequestsSent", fields: [fromUserId], references: [id], onDelete: Cascade)
  fromUserId String
  toUser     User             @relation("RequestsReceived", fields: [toUserId], references: [id], onDelete: Cascade)
  toUserId   String
  scope      ConnectionType
  status     ConnectionStatus
  createdAt  DateTime         @default(now())

  @@unique([fromUserId, toUserId, scope])
}

model User {
  id                      String    @id @default(cuid())
  email                   String    @unique
  tokenVersion            Int       @default(0)
  loginToken              String?   @unique
  loginTokenExp           DateTime?
  isActive                Boolean   @default(true)
  isBlocked               Boolean   @default(false)
  isRegistrationConfirmed Boolean   @default(false)
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  lastLoginAt             DateTime?
  language                String?   @default("en")

  // relations
  profile       Profile?       @relation
  datingProfile DatingProfile? @relation
  ProfileImage  ProfileImage[]

  requestsSent     ConnectionRequest[] @relation("RequestsSent")
  requestsReceived ConnectionRequest[] @relation("RequestsReceived")
}

model Profile {
  id         String @id @default(cuid())
  publicName String
  intro      String
  country    String @default("")
  city       String @default("")

  isActive   Boolean @default(true)
  isReported Boolean @default(false)
  isBlocked  Boolean @default(false)

  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  tags ProfileTag[]

  profileImageId String?        @unique
  profileImage   ProfileImage?  @relation(name: "ProfilePrimaryImage", fields: [profileImageId], references: [id])
  otherImages    ProfileImage[] @relation(name: "ProfileOtherImages")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DatingProfile {
  id           String             @id @default(cuid())
  publicName   String
  intro        String
  country      String             @default("")
  city         String             @default("")
  birthday     DateTime?
  gender       Gender             @default(unspecified)
  relationship RelationshipStatus @default(unspecified)
  hasKids      HasKids            @default(unspecified)

  isActive   Boolean @default(true)
  isReported Boolean @default(false)
  isBlocked  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  datingPreference DatingPreference?
  tags             ProfileTag[]

  profileImageId String?        @unique
  profileImage   ProfileImage?  @relation(name: "DatingProfilePrimaryImage", fields: [profileImageId], references: [id])
  otherImages    ProfileImage[] @relation(name: "DatingProfileOtherImages")
}

model ProfileImage {
  id       String @id @default(cuid())
  mimeType String
  userId   String
  user     User   @relation(fields: [userId], references: [id])

  altText     String?
  storagePath String

  primaryForProfile       Profile?        @relation("ProfilePrimaryImage")
  otherForProfiles        Profile[]       @relation("ProfileOtherImages")
  primaryForDatingProfile DatingProfile?  @relation("DatingProfilePrimaryImage")
  otherForDatingProfiles  DatingProfile[] @relation("DatingProfileOtherImages")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
